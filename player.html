<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>

<body>
    <style>
        body {
            background-color: #000000;
            color: #FFFFFF;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        button {
            padding: 1em;
        }
        .vk-round {
            height: 10vw;
            width: 10vw;
            text-align: center;
            vertical-align: middle;
            line-height: 10vw;
            font-size: 10vw;

            border-radius: 50%;
            display: inline-block;
        }

        .vk-rect {
            height: 5vw;
            width: 20vw;
            text-align: center;
            vertical-align: middle;
            line-height: 5vw;
            font-size: 5vw;
            display: inline-block;
        }

        .vk-updown {
            height: 10vw;
            width: 10vw;
            text-align: center;
            vertical-align: middle;
            line-height: 10vw;
            font-size: 5vw;
            display: inline-block;
        }

        .vk-leftright {
            height: 10vw;
            width: 10vw;
            text-align: center;
            vertical-align: middle;
            line-height: 10vw;
            font-size: 5vw;
            display: inline-block;
        }

        .vk {
            color: rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.25);
            position: absolute;
            z-index: 1;
        }

        .vk-touched {
            background-color: rgba(255, 255, 255, 0.75) !important
        }

        .menu {
            background: #202b38;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #gba-canvas {
            position: absolute;
            z-index: -1;
        }

        #vk-layer {
            position: absolute;
            left:0;
            top:0;
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        #msg-layer {
            position: absolute;
            left:0;
            width:100%;
            top:40vh;
            background: #000000;
            z-index: 4;
        }

    </style>
    <div id="welcome" class="menu">
        
        <h1>GBA Player</h1>
        Version 1.1
        <hr>
        <div id="wasm-loading">
            Loading WASM, please wait...
        </div>
        <div id="select-rom" hidden>
            <p>Select a file:<br><input type="file" id="romFile" /></p>
            <button onclick="loadButtonClick()" style="width:8em;">Load</button><br>
        </div>

        <hr>
    </div>
    <div id="msg-layer" hidden>
        <hr>
        <p id="msg-text"></p>
        <hr>
    </div>
    <div id="vk-layer" hidden>
        <div class="vk-rect vk" data-k="menu" style="left:0;bottom:0;left:40vw;">Menu</div>
        <div class="vk-rect vk" data-k="l" style="left:0;top:80px;">L</div>
        <div class="vk-rect vk" data-k="r" style="right:0;top:80px;">R</div>
        <div class="vk-round vk" data-k="a" style="bottom:11vw;right:0;">A</div>
        <div class="vk-round vk" data-k="b" style="bottom:0;right:15vw;">B</div>
        <div class="vk-rect vk" data-k="select" style="left: 28vw; top:80px;">Select</div>
        <div class="vk-rect vk" data-k="start" style="left:52vw; top:80px;">Start</div>
        <div class="vk-leftright vk" data-k="left" style="bottom:10vw;left:0;">←</div>
        <div class="vk-leftright vk" data-k="right" style="bottom:10vw;left:20vw;">→</div>
        <div class="vk-updown vk" data-k="up" style="bottom:20vw;left:10vw;">↑</div>
        <div class="vk-updown vk" data-k="down" style="bottom:0;left:10vw;">↓</div>

    </div>
    <canvas width="240" height="160" id="gba-canvas" style="image-rendering: pixelated;"></canvas>
    <script src="localforage.js"></script>
    <script>
        var keyState = {
        };
        const keyList = ["a", "b", "select", "start", "right", "left", 'up', 'down', 'r', 'l'];

        const AUDIO_BLOCK_SIZE = 1024
        const AUDIO_FIFO_MAXLEN = 8192
        var audioContext
        var scriptProcessor
        var audioFifo0 = new Int16Array(AUDIO_FIFO_MAXLEN)
        var audioFifo1 = new Int16Array(AUDIO_FIFO_MAXLEN)
        var audioFifoHead = 0
        var audioFifoCnt = 0

        var fileInput = document.getElementById('romFile')
        var canvas = document.getElementById('gba-canvas')
        var drawContext = canvas.getContext('2d')
        var romBuffer = -1
        var idata
        var isRunning = false
        var isWasmReady = false
        var wasmAudioBuf
        var wasmSaveBuf
        const wasmSaveBufLen = 0x20000 + 0x2000
        var tmpSaveBuf = new Uint8Array(wasmSaveBufLen)

        var frameCnt = 0
        var last128FrameTime = 0
        var lastFrameTime = 0
        var frameSkip = 0
        var lowLatencyMode = false

        var lastCheckedSaveState = 0

        var gameID


        function processAudio(event) {
            var outputBuffer = event.outputBuffer
            var audioData0 = outputBuffer.getChannelData(0)
            var audioData1 = outputBuffer.getChannelData(1)
            if (!isRunning) {
                return
            }

            if (!lowLatencyMode) {
                while (audioFifoCnt < AUDIO_BLOCK_SIZE) {
                    //console.log('audio fifo underflow, running a new frame')
                    lastFrameTime = performance.now()
                    Module._runFrame(getJoyState())
                }
            }
            var copySize = AUDIO_BLOCK_SIZE
            if (audioFifoCnt < copySize) {
                copySize = audioFifoCnt
            }
            for (var i = 0; i < copySize; i++) {
                audioData0[i] = audioFifo0[audioFifoHead] / 32768.0
                audioData1[i] = audioFifo1[audioFifoHead] / 32768.0
                audioFifoHead = (audioFifoHead + 1) % AUDIO_FIFO_MAXLEN
                audioFifoCnt--
            }
        }

        // must be called in user gesture
        function tryInitSound() {
            if (audioContext) {
                return;
            }
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
                scriptProcessor = audioContext.createScriptProcessor(AUDIO_BLOCK_SIZE, 0, 2)
                scriptProcessor.onaudioprocess = processAudio
                scriptProcessor.connect(audioContext.destination)

                audioContext.resume()
            } catch (e) {
                console.log(e)
                alert('Cannnot init sound ')
            }
        }



        function writeAudio(ptr, frames) {
            //console.log(ptr, frames)
            if (!wasmAudioBuf) {
                wasmAudioBuf = new Int16Array(Module.HEAPU8.buffer).subarray(ptr / 2, ptr / 2 + 2048)
            }
            var tail = (audioFifoHead + audioFifoCnt) % AUDIO_FIFO_MAXLEN
            if (audioFifoCnt + frames >= AUDIO_FIFO_MAXLEN) {
                console.log('audio fifo overflow (wow)', audioFifoCnt)
                return
            }
            for (var i = 0; i < frames; i++) {
                audioFifo0[tail] = wasmAudioBuf[i * 2]
                audioFifo1[tail] = wasmAudioBuf[i * 2 + 1]
                tail = (tail + 1) % AUDIO_FIFO_MAXLEN
            }
            audioFifoCnt += frames
        }

        function drawFrame(ptr) {
            //console.log(ptr)
            if (!idata) {
                // assuming ptr is always same
                idata = new ImageData(new Uint8ClampedArray(Module.HEAPU8.buffer).subarray(ptr, ptr + 240 * 160 * 4), 240, 160)
            }
            drawContext.putImageData(idata, 0, 0)
        }

        function wasmReady() {
            romBuffer = Module._malloc(33 * 1024 * 1024)
            var ptr = Module._getSaveBuf()
            wasmSaveBuf = Module.HEAPU8.subarray(ptr, ptr + wasmSaveBufLen)
            isWasmReady = true
            document.getElementById('wasm-loading').hidden = true
            document.getElementById('select-rom').hidden = false

        }

        function loadSaveGame(index, cb) {
            console.log('load', gameID, index)
            localforage.getItem(gameID + '-save-' + index, function(err, data) {
                //console.log(err, data)
                if (data) {
                    wasmSaveBuf.set(data)
                    clearSaveBufState()
                    cb(true)
                } else {
                    clearSaveBufState()
                    cb(false)
                }
            })
        }

        function saveSaveGame(index,  cb) {
            console.log('save', gameID, index)
            tmpSaveBuf.set(wasmSaveBuf)
            localforage.setItem(gameID + '-save-' + index, tmpSaveBuf, function(err, data) {
                cb(true)
            })
        }

        function loadRomArrayBuffer(arrayBuffer) {
            isRunning = false
            console.log(arrayBuffer)
            var u8 = new Uint8Array(arrayBuffer)
            gameID = ""
            if (u8[0xB2] != 0x96) {
                alert('Not a valid GBA ROM!')
                return
            }
            for (var i = 0xAC; i < 0xB2; i++) {
                gameID += String.fromCharCode(u8[i])
            }
            console.log(gameID)
            Module.HEAPU8.set(u8, romBuffer)
            var ret = Module._loadRom(romBuffer, u8.length)
            document.getElementById('welcome').hidden = true
            loadSaveGame(0, function() {
                Module._resetCpu()
                isRunning = true
            })

        }

        function loadButtonClick() {
            if (!isWasmReady) {
                alert('WASM not ready!')
                return
            }
            tryInitSound()
            var blob = fileInput.files[0]
            var arrayBuffer
            var fileReader = new FileReader()
            fileReader.onload = function (event) {
                var arrayBuffer = event.target.result
                loadRomArrayBuffer(arrayBuffer)
            };
            fileReader.readAsArrayBuffer(blob)
        }


        function emuLoop() {
            window.requestAnimationFrame(emuLoop)
            if (isRunning) {
                lastFrameTime = performance.now()
                Module._runFrame(getJoyState());
            }
        }
        emuLoop()

        function adjustSize() {
            var gbaMaxWidth = window.innerWidth
            var gbaMaxHeight = window.innerHeight
            var l = 0
            var w = gbaMaxWidth
            var h = w / 240 * 160
            if (h > gbaMaxHeight) {
                h = gbaMaxHeight
                w = h / 160 * 240
            }
            l += (gbaMaxWidth - w) / 2;
            x = 'image-rendering:pixelated;' + 'width:' + w + 'px;height:' + h + 'px;left:' + l + 'px;'
            canvas.style = x
        }

        window.onresize = adjustSize
        window.onorientationchange = adjustSize
        adjustSize()


        function initVK() {
            var vks = document.getElementsByClassName('vk')
            for (var i = 0; i < vks.length; i++) {
                var vk = vks[i]
                var k = vks[i].getAttribute('data-k')
                keyState[k] = [vk, 0, 0]
            }
        }
        initVK()

        function handleTouch(event) {
            event.preventDefault()
            if (!isRunning) {
                return
            }
            
            document.getElementById('vk-layer').hidden = false
            for (var k in keyState) {
                keyState[k][2] = 0
            }
            for (var i = 0; i < event.touches.length; i++) {
                var t = event.touches[i];
                var dom = document.elementFromPoint(t.clientX, t.clientY)
                if (dom) {
                    var k = dom.getAttribute('data-k')
                    if (k) {
                        keyState[k][2] = 1

                    }
                }
            }
            for (var k in keyState) {
                if (keyState[k][1] != keyState[k][2]) {
                    var dom = keyState[k][0]
                    keyState[k][1] = keyState[k][2]
                    if (keyState[k][1]) {
                        dom.classList.add('vk-touched')
                    } else {
                        dom.classList.remove('vk-touched')
                    }

                }
            }
        }
        window.ontouchstart = handleTouch;
        window.ontouchmove = handleTouch;
        window.ontouchcancel = handleTouch;
        window.ontouchend = handleTouch;

        function getJoyState() {
            var ret = 0;
            for (var i = 0; i < 10; i++) {
                ret = ret | (keyState[keyList[i]][1] << i);
            }
            return ret;
        }

        function convertKeyCode(keyCode) {
            const keymap = [90, 88, 8, 13, 39, 37, 38, 40, 17, 16]
            for (var i = 0; i < 10; i++) {
                if (keyCode == keymap[i]) {
                    return i
                }
            }
            return -1
        }

        document.onkeydown = function (e) {
            if (!isRunning) {
                return
            }
            e.preventDefault()
            var k = convertKeyCode(e.keyCode)
            if (k >= 0) {
                keyState[keyList[k]][1] = 1
            }
        }

        document.onkeyup = function (e) {
            if (!isRunning) {
                return
            }
            e.preventDefault()
            var k = convertKeyCode(e.keyCode)
            if (k >= 0) {
                keyState[keyList[k]][1] = 0
            }
        }

        function checkSaveBufState() {
            if (!isRunning) {
                return;
            }
            var state = Module._updateSaveBufState()
            //console.log(state)
            if ((lastCheckedSaveState == 1) && (state == 0)) {
                showMsg('Auto saving, please wait...')
                saveSaveGame(0, function() {
                    console.log('save done')
                })
            }
            lastCheckedSaveState = state
        }

        function clearSaveBufState() {
            lastCheckedSaveState = 0
            Module._updateSaveBufState()
        }

        setInterval(checkSaveBufState, 1000)

        function showMsg(msg) {
            document.getElementById('msg-text').innerText = msg
            document.getElementById('msg-layer').hidden = false
            setTimeout(function() {
                document.getElementById('msg-layer').hidden = true
            }, 1000)
        }
    </script>
    <script src="a.out.js"></script>

</body>

</html>